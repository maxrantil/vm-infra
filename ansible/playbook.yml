# ABOUTME: Ansible playbook for development environment provisioning

---
- name: Configure Ubuntu VMs
  hosts: all
  become: yes

  vars:
    # User and home directory configuration
    user_home: "/home/{{ ansible_user }}"

    # SSH key paths (source on controller, destination on VM)
    ssh_key_path: "{{ user_home }}/.ssh/id_ed25519"
    ssh_pub_key_path: "{{ user_home }}/.ssh/id_ed25519.pub"
    ssh_dir: "{{ user_home }}/.ssh"

    # Dotfiles repository and directory
    dotfiles_repo: "git@github.com:maxrantil/dotfiles.git"
    dotfiles_dir: "{{ user_home }}/.dotfiles"

    # Neovim directories
    nvim_undo_dir: "{{ user_home }}/.cache/nvim/undo"
    nvim_autoload_dir: "{{ user_home }}/.config/nvim/autoload"

    # Tmux plugin directory
    tmux_plugins_dir: "{{ user_home }}/.tmux/plugins/tpm"

  tasks:
    - block:
        - name: Ensure system is up to date
          apt:
            update_cache: yes
            upgrade: dist

        - name: Install core packages
          apt:
            name:
              # Core tools
              - git
              - curl
              - wget
              - vim
              - neovim
              - zsh
              - build-essential
              - python3
              - python3-pip
              - python3-venv

              # CLI productivity tools
              - tmux
              - bat
              - fzf
              - ripgrep
              - fd-find
              - jq
              - tree
              - htop
              - ncdu
              - tldr

              # Development tools
              - gh  # GitHub CLI
              - shellcheck
              - cmake
              - ansible

              # Utilities
              - ccze
              - unzip
              - zip
              - net-tools

            state: present
          register: package_install_result

        # yq needs to be installed manually (not in Ubuntu repos with good version)
        - name: Install yq
          get_url:
            url: https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            dest: /usr/local/bin/yq
            mode: '0755'

        # fd is installed as fdfind on Ubuntu, create symlink
        - name: Create fd symlink
          file:
            src: /usr/bin/fdfind
            dest: /usr/local/bin/fd
            state: link

        # bat is installed as batcat on Ubuntu, create symlink
        - name: Create bat symlink
          file:
            src: /usr/bin/batcat
            dest: /usr/local/bin/bat
            state: link

        # Install git-delta for better diffs
        - name: Get latest git-delta release URL
          shell: curl -s https://api.github.com/repos/dandavison/delta/releases/latest | grep "browser_download_url.*x86_64-unknown-linux-gnu.tar.gz" | cut -d '"' -f 4
          register: delta_url
          changed_when: false

        - name: Install git-delta
          get_url:
            url: "{{ delta_url.stdout }}"
            dest: /tmp/delta.tar.gz
            mode: '0644'

        - name: Extract git-delta
          unarchive:
            src: /tmp/delta.tar.gz
            dest: /tmp/
            remote_src: yes

        - name: Move delta binary to /usr/local/bin
          shell: |
            find /tmp -name delta -type f -executable -exec mv {} /usr/local/bin/delta \;
            chmod +x /usr/local/bin/delta
          args:
            creates: /usr/local/bin/delta

        # Install lf (terminal file manager)
        - name: Get latest lf release URL
          shell: curl -s https://api.github.com/repos/gokcehan/lf/releases/latest | grep "browser_download_url.*linux-amd64.tar.gz" | cut -d '"' -f 4
          register: lf_url
          changed_when: false

        - name: Install lf
          get_url:
            url: "{{ lf_url.stdout }}"
            dest: /tmp/lf.tar.gz
            mode: '0644'

        - name: Extract lf
          unarchive:
            src: /tmp/lf.tar.gz
            dest: /tmp/
            remote_src: yes

        - name: Move lf binary to /usr/local/bin
          command: mv /tmp/lf /usr/local/bin/lf
          args:
            creates: /usr/local/bin/lf

        - name: Set lf executable permissions
          file:
            path: /usr/local/bin/lf
            mode: '0755'

        # Install starship prompt
        - name: Download starship installer
          get_url:
            url: https://starship.rs/install.sh
            dest: /tmp/starship-install.sh
            mode: '0755'

        - name: Install starship
          shell: /tmp/starship-install.sh -y
          args:
            creates: /usr/local/bin/starship

        - name: Change default shell to zsh for user
          user:
            name: "{{ ansible_user }}"
            shell: /usr/bin/zsh

        # Setup SSH for git operations
        - name: Create .ssh directory for user
          file:
            path: "{{ ssh_dir }}"
            state: directory
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            mode: '0700'

        # CVE-2024-ANSIBLE-001: Generate VM-specific deploy keys (CVSS 9.3)
        # Security: Each VM gets unique key instead of copying host SSH key
        - name: Generate VM-specific deploy key
          command: ssh-keygen -t ed25519 -f {{ ssh_key_path }} -N "" -C "vm-deploy-{{ ansible_hostname }}"
          args:
            creates: "{{ ssh_key_path }}"
          become_user: "{{ ansible_user }}"

        - name: Set deploy key permissions
          file:
            path: "{{ ssh_key_path }}"
            mode: '0600'
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"

        - name: Display public deploy key
          shell: cat {{ ssh_pub_key_path }}
          register: deploy_key_output
          become_user: "{{ ansible_user }}"
          changed_when: false

        - name: Deploy key setup instructions
          debug:
            msg: |
              ═══════════════════════════════════════════════════════════════
              ⚠️  MANUAL STEP REQUIRED: Add Deploy Key to GitHub ⚠️
              ═══════════════════════════════════════════════════════════════

              Copy the key below and add it to your GitHub repository:

              {{ deploy_key_output.stdout }}

              Steps:
              1. Go to: https://github.com/maxrantil/dotfiles/settings/keys
              2. Click "Add deploy key"
              3. Title: vm-{{ ansible_hostname }}-deploy-key
              4. Paste the key above
              5. ✓ Check "Allow write access" if needed for push operations
              6. Click "Add key"

              After adding the deploy key, dotfiles will be accessible from this VM.
              ═══════════════════════════════════════════════════════════════

        - name: Add GitHub to known hosts
          known_hosts:
            name: github.com
            key: "{{ lookup('pipe', 'ssh-keyscan -t rsa github.com') }}"
            path: "{{ ssh_dir }}/known_hosts"
            state: present
          become_user: "{{ ansible_user }}"

        # Copy local dotfiles (if --test-dotfiles flag used)
        - name: Copy local dotfiles from host to VM
          synchronize:
            src: "{{ dotfiles_local_path }}/"
            dest: "{{ dotfiles_dir }}"
            delete: no
            recursive: yes
          become_user: "{{ ansible_user }}"
          when: dotfiles_local_path is defined and dotfiles_local_path != ''
          register: dotfiles_copy_result

        # Clone dotfiles repository (if NOT using local dotfiles)
        # CVE-4: Git shallow clone to limit history exposure (CVSS 7.5)
        - name: Clone dotfiles repository
          git:
            repo: "{{ dotfiles_repo }}"
            dest: "{{ dotfiles_dir }}"
            clone: yes
            update: yes
            depth: 1
          become_user: "{{ ansible_user }}"
          when: dotfiles_local_path is not defined or dotfiles_local_path == ''
          register: dotfiles_clone_result

        # Run dotfiles install script
        - name: Run dotfiles install script
          command: "{{ dotfiles_dir }}/install.sh"
          become_user: "{{ ansible_user }}"
          args:
            creates: "{{ dotfiles_dir }}/.install_complete"

        - name: Mark dotfiles installation as complete
          file:
            path: "{{ dotfiles_dir }}/.install_complete"
            state: touch
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            mode: '0644'

        # Install zsh plugins
        - name: Install zsh-syntax-highlighting
          apt:
            name: zsh-syntax-highlighting
            state: present

        - name: Install zsh-autosuggestions
          apt:
            name: zsh-autosuggestions
            state: present

        # Create nvim directories
        - name: Create nvim undo directory
          file:
            path: "{{ nvim_undo_dir }}"
            state: directory
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            mode: '0700'

        - name: Create nvim autoload directory
          file:
            path: "{{ nvim_autoload_dir }}"
            state: directory
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            mode: '0755'

        # Install vim-plug for neovim
        - name: Install vim-plug for neovim
          get_url:
            url: https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
            dest: "{{ nvim_autoload_dir }}/plug.vim"
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            mode: '0644'
          become_user: "{{ ansible_user }}"

        # Install tmux plugin manager (TPM)
        # Security: Use HTTPS for public repository (no deploy key needed)
        # Note: Temporarily disabled for local dotfiles testing (git config conflicts)
        # TODO: Re-enable after fixing git URL rewriting in dotfiles
        # - name: Clone TPM (tmux plugin manager)
        #   command: "git -c 'url.https://github.com/.insteadOf=git@github.com:' clone https://github.com/tmux-plugins/tpm {{ tmux_plugins_dir }}"
        #   args:
        #     creates: "{{ tmux_plugins_dir }}/.git"
        #   become_user: "{{ ansible_user }}"

        - name: Configure SSH to disable password auth
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?PasswordAuthentication'
            line: 'PasswordAuthentication no'
          notify: restart ssh

      rescue:
        # State-tracked rollback: Only cleanup if the task was attempted and failed
        # package_install_result is set via 'register:' directive in main tasks
        - name: Rollback - Remove partially installed packages
          apt:
            autoremove: yes  # Remove orphaned dependencies
            purge: yes       # Remove configuration files
          when: package_install_result is defined and package_install_result is failed
          ignore_errors: yes

        # State-tracked rollback: Cleanup dotfiles if clone was attempted
        # dotfiles_clone_result is set via 'register:' directive in main tasks
        - name: Rollback - Remove dotfiles directory
          file:
            path: "{{ dotfiles_dir }}"
            state: absent
          when: dotfiles_clone_result is defined
          ignore_errors: yes  # Continue even if directory doesn't exist

        - name: Report failure and recovery guidance
          debug:
            msg: |
              ═══════════════════════════════════════════════════════════════
              ⚠️  PROVISIONING FAILED - VM in Partially Configured State  ⚠️
              ═══════════════════════════════════════════════════════════════

              The Ansible playbook encountered an error during provisioning.
              Some cleanup tasks have been attempted, but manual intervention
              may be required.

              Recovery Options:

              1. RECOMMENDED: Destroy and recreate the VM
                 ./destroy-vm.sh {{ ansible_hostname }}
                 ./provision-vm.sh {{ ansible_hostname }}

              2. ALTERNATIVE: Manually fix the issue and re-run Ansible
                 cd ansible
                 ansible-playbook -i inventory.ini playbook.yml

              3. Check the error messages above for specific failure details

              ═══════════════════════════════════════════════════════════════

      always:
        - name: Log provisioning result
          delegate_to: localhost
          become: no
          copy:
            content: |
              {{ ansible_date_time.iso8601 }}: Provisioning {{ 'FAILED' if ansible_failed_task is defined else 'COMPLETED' }} for {{ ansible_hostname }}
              {% if ansible_failed_task is defined %}
              Failed task: {{ ansible_failed_task.name }}
              {% endif %}
            dest: "./provisioning.log"
            mode: '0600'

  handlers:
    - name: restart ssh
      service:
        name: ssh
        state: restarted
